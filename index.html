<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    let count = 0;
    const startTime = new Date().getTime();
    const hostName = "https://api-prashant.eng.macrometa.io";
    const logFileName = "server.log";
    const streamName = "c8locals.input_log_stream";
    const urlParams = new URLSearchParams(window.location.search);

    // Empty the values if we decide to get the email/password from the URL
    let email = "mm@macrometa.io";
    let password = "Test1234";
    let mmJwtToken;

    // Convert the message to string
    function convertToString(line){
        const message = {
            "log":line,
        };
        return JSON.stringify(message);    
    }

    // Publish the EOF file message
    function publishEOF(){
        const eofFlag = "EOF";
        console.log("Sending EOF flag...");
        const eofLog=`13.66.139.0 - - [12/Feb/2021:00:00:23 +0100] "${eofFlag} /index.php?option=com_phocagallery&view=category&id=1:almhuette-raith&Itemid=53 HTTP/1.1" 404 32653 "-" "Mozilla/5.0 (compatible; bingbot/2.0; +https://www.macrometa.com)" "-"`;
        pulbishLog(eofLog);
    }

    // Get the JWT Token
    function getMMJwtToken(email, password){
        $.ajax({
            url: `${hostName}/_open/auth`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({"email": email, "password": password}),
            datatype: 'json',
            async: false,
            success: function(result) {
                mmJwtToken = result.jwt;
                console.log("Got JWT token: ", result); 
            },
            error: function(err) {  
                console.log('Failed in getMMJwtToken:' + err); 
            },
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", `bearer ${mmJwtToken}`);
            }
        });
    }

    // Publish the incoming log to the stream
    function pulbishLog(log) {
        $.ajax({
            url: `${hostName}/_fabric/_system/_api/streams/${streamName}/publish?global=false`,
            type: 'POST',
            contentType: 'application/json',
            data: convertToString(log),
            datatype: 'application/json',
            async: false,
            success: function(result) { 
                console.log("Success pulbishLog:", result); 
            },
            error: function(err) {  
                console.log('Failed in pulbishLog for the log: ' + err); 
            },
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", `bearer ${mmJwtToken}`);
            }
        });
    }

    function parseResult(result){
        var lines = result.split("\n");
        for (var i = 0, len = lines.length; i < len; i++) {
            //console.log("Read >> " + lines[i]);
            pulbishLog(lines[i]);
            count++;
        }
    }

    // Read the log file and start the publishing
    function main() {
        $.ajax({
            url: `https://raw.githubusercontent.com/Macrometacorp/tutorial-log-analytics/main/${logFileName}?token=ARWTGKPVP4JCPIUIODEYGH3AHSUXA`,
            type: 'GET',
            datatype: 'application/json',
            async: false,
            success: function(result) { 
                console.log(result);
                mmJwtToken = getMMJwtToken(email, password);
                parseResult(result);
                publishEOF();
                const endTime = new Date().getTime();
                const time = ( endTime - startTime) / 1000;
                console.log(`Published ${count} logs in ${time} seconds. It will take some time to reflect aggregated records in the collection.`);
            },
            error: function(err) { 
                console.log('Failed in main:', err); 
            },
        });  
    }

    // Start the publishing on page load itself
    $( document ).ready(function() {
        // Uncomment this if not if we decide to get the email/password from the URL
        // const urlParams = new URLSearchParams(window.location.search);
        // email = urlParams.get('email') !== null ? urlParams.get('email') : email;
        // password = urlParams.get('password') !== null ? urlParams.get('password') : password;
        // console.log( `Starting to publish... email:${email} -- password:${password}` );
        console.log( `Logs will be published one by one soon...` );
    });
</script>
</head>
<body>
    <h3>Macrometa Realtime Log Analytics Demo</h3></br>
    <button onclick="main()">Publish</button>
</body>
</html>
