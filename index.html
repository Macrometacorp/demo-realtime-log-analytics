<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    let count = 0;
    const startTime = new Date().getTime();
    const hostName = "https://api-prashant.eng.macrometa.io";
    const logFileName = "server.log";
    const streamName = "c8locals.input_log_stream";
    const urlParams = new URLSearchParams(window.location.search);

    // Empty the values if we decide to get the email/password from the URL
    let email = "mm@macrometa.io";
    let password = "Test1234";
    let mmJwtToken;

    // Convert the message to string
    function convertToString(line){
        const message = {
            "log":line,
        };
        return JSON.stringify(message);    
    }

    // Publish the EOF file message
    function publishEOF(){
        const eofFlag = "EOF";
        console.log("Sending EOF flag...");
        const eofLog=`13.66.139.0 - - [12/Feb/2021:00:00:23 +0100] "${eofFlag} /index.php?option=com_phocagallery&view=category&id=1:almhuette-raith&Itemid=53 HTTP/1.1" 404 32653 "-" "Mozilla/5.0 (compatible; bingbot/2.0; +https://www.macrometa.com)" "-"`;
        pulbishLog(eofLog);
    }

    // Get the JWT Token
    function getMMJwtToken(email, password){
        $.ajax({
            url: `${hostName}/_open/auth`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({"email": email, "password": password}),
            datatype: 'json',
            async: false,
            success: function(result) {
                mmJwtToken = result.jwt;
                console.log("Got JWT token: ", result); 
            },
            error: function(err) {  
                console.log('Failed in getMMJwtToken:' + err); 
            },
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", `bearer ${mmJwtToken}`);
            }
        });
    }

    // Publish the incoming log to the stream
    function pulbishLog(log) {
        $.ajax({
            url: `${hostName}/_fabric/_system/_api/streams/${streamName}/publish?global=false`,
            type: 'POST',
            contentType: 'application/json',
            data: convertToString(log),
            datatype: 'application/json',
            async: false,
            success: function(result) { 
               // console.log("Success pulbishLog:", result); 
            },
            error: function(err) {  
                console.log('Failed in pulbishLog for the log: ' + err); 
            },
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", `bearer ${mmJwtToken}`);
            }
        });
    }

    function parseResult(result){
        var lines = result.split("\n");
        for (var i = 0, len = lines.length; i < len; i++) {
            //console.log("Read >> " + lines[i]);
            pulbishLog(lines[i]);
            count++;
        }
    }

    // Read the log file and start the publishing
    function main() {
        $.ajax({
            url: `https://raw.githubusercontent.com/Macrometacorp/tutorial-log-analytics/main/${logFileName}?token=ARWTGKPVP4JCPIUIODEYGH3AHSUXA`,
            type: 'GET',
            datatype: 'application/json',
            async: false,
            success: function(result) { 
                console.log(result);
                mmJwtToken = getMMJwtToken(email, password);
                parseResult(result);
                publishEOF();
                const endTime = new Date().getTime();
                const time = ( endTime - startTime) / 1000;
                console.log(`Published ${count} logs in ${time} seconds. It will take some time to reflect aggregated records in the collection.`);
            },
            error: function(err) { 
                console.log('Failed in main:', err); 
            },
        });  
    }

    // Start the publishing on page load itself
    $( document ).ready(function() {
        // Uncomment this if not if we decide to get the email/password from the URL
        // const urlParams = new URLSearchParams(window.location.search);
        // email = urlParams.get('email') !== null ? urlParams.get('email') : email;
        // password = urlParams.get('password') !== null ? urlParams.get('password') : password;
        // console.log( `Starting to publish... email:${email} -- password:${password}` );
        console.log( `Logs will be published one by one soon...` );
    });
</script>
<style>
    .center {
      text-align: center;
      margin: auto;
      width: 50%;
    }

    .main-header {
      margin-top: 25px;
    }

    #publish-button:hover{
        background-color: #1971b3;
    }

    #publish-button {
        width: 200px;
        color: #fff;
        border:none;
        background-color: #58a6e6;
        border-radius: 3px;
        border-radius: 3px;
      
        border-color: #fff;
        cursor: pointer;
        transition-delay: 0s;
        transition-duration: 0.2s;
        align-items: center;
       
        font-size: .875rem;
        font-style: normal;
        font-weight: 500;
        line-height: 1.5rem;
        margin: 0;
        padding: .5rem .75rem;
    }

    #button-container{
        padding-top: 30px;
    }

    .details-table{
        margin-top: 50px;
        margin-left: 40px;
    }

    ul{
        list-style-type: none;
        margin-top: 30px;
    }

    li span{
        font-weight: bold;
    }

    li {
        margin-top: 10px;
    }
</style>
</head>
<body>
    <div id="head">
        <h1 class="center main-header">Macrometa Realtime Log Analytics Demo</h1>
        <h2 class="center">(Log Producer)</h2>
        <div id="button-container" class="center"><button id="publish-button" onclick="main()">Publish</button></div>
    </div>
    <ul id="details">
        <li><span>GDN URL:</span> pass.gdn.macrometa.io</li>
        <li><span>Stream Name:</span> c8locals.input_log_stream</li>
        <li><span>Log records:</span> 21,237</li>
    </ul>
    <ul id="logs">
        <li><span>Log Records Sample:</span></li>
        <li>216.244.66.230 - - [19/Dec/2020:14:14:26 +0100] "GET /robots.txt HTTP/1.1" 200 304 "-" "Mozilla/5.0 (compatible; DotBot/1.1; http://www.opensiteexplorer.org/dotbot, help@moz.com)" "-"</li>
        <li>54.36.148.92 - - [19/Dec/2020:14:16:44 +0100] "GET /index.php?option=com_phocagallery&view=category&id=2%3Awinterfotos&Itemid=53 HTTP/1.1" 200 30662 "-" "Mozilla/5.0 (compatible; AhrefsBot/7.0; +http://ahrefs.com/robot/)" "-"</li>
        <li>92.101.35.224 - - [19/Dec/2020:14:29:21 +0100] "GET /administrator/index.php HTTP/1.1" 200 4263 "" "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322)" "-"</li>
        <li>73.166.162.225 - - [19/Dec/2020:14:58:59 +0100] "GET /apache-log/access.log HTTP/1.1" 200 1299 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.101 Safari/537.36" "-"</li>
        <li>73.166.162.225 - - [19/Dec/2020:14:58:59 +0100] "GET /favicon.ico HTTP/1.1" 404 217 "http://www.almhuette-raith.at/apache-log/access.log" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.101 Safari/537.36" "-"</li>
        <li>54.36.148.108 - - [19/Dec/2020:15:09:30 +0100] "GET /robots.txt HTTP/1.1" 200 304 "-" "Mozilla/5.0 (compatible; AhrefsBot/7.0; +http://ahrefs.com/robot/)" "-"</li>
    </ul>
</body>
</html>
